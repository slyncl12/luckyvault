/**
 * NAVI Protocol Integration Service
 * Fixed to use correct pool structure
 */

import { getPools } from '@naviprotocol/lending';
import { SuiClient } from '@mysten/sui/client';

const SUI_RPC_URL = 'https://fullnode.mainnet.sui.io';

export interface NaviPoolStats {
  supplyAPY: number;
  borrowAPY: number;
  utilizationRate: number;
  totalSupply: string;
  totalBorrow: string;
  availableLiquidity: string;
}

export class NaviService {
  private suiClient: SuiClient;
  private lastAPY: number = 0;
  private lastAPYUpdate: number = 0;
  private APY_CACHE_MS = 60000; // Cache for 1 minute

  constructor() {
    this.suiClient = new SuiClient({ url: SUI_RPC_URL });
  }

  /**
   * Get real-time USDC supply APY from NAVI
   * This is LIVE data from NAVI's on-chain pools
   */
  async getUSDCSupplyAPY(): Promise<number> {
    const now = Date.now();
    if (this.lastAPY > 0 && (now - this.lastAPYUpdate) < this.APY_CACHE_MS) {
      return this.lastAPY;
    }

    try {
      const pools = await getPools({ 
        env: 'prod',
        cacheTime: 60000
      });
      
      // Find USDC pool using token.symbol
      const usdcPool = pools.find(p => 
        p.token?.symbol === 'USDC' ||
        p.coinType?.includes('dba34672e30cb065b1f93e3ab55318768fd6fef66c15942c9f7cb846e2f900e7')
      );
      
      if (!usdcPool) {
        throw new Error('USDC pool not found in NAVI');
      }

      // Get APY from supplyIncentiveApyInfo
      const apyString = usdcPool.supplyIncentiveApyInfo?.apy;
      if (!apyString) {
        throw new Error('APY data not available');
      }

      this.lastAPY = parseFloat(apyString);
      this.lastAPYUpdate = now;
      
      console.log(`‚úÖ NAVI Real-time APY: ${this.lastAPY.toFixed(2)}%`);
      return this.lastAPY;
      
    } catch (error) {
      console.error('‚ùå Error fetching NAVI APY:', error);
      if (this.lastAPY > 0) {
        console.log(`‚ö†Ô∏è  Using cached APY: ${this.lastAPY.toFixed(2)}%`);
        return this.lastAPY;
      }
      throw error;
    }
  }

  /**
   * Get detailed pool statistics
   */
  async getUSDCPoolStats(): Promise<NaviPoolStats> {
    try {
      const pools = await getPools({ env: 'prod' });
      const usdcPool = pools.find(p => p.token?.symbol === 'USDC');
      
      if (!usdcPool) {
        throw new Error('USDC pool not found');
      }

      const supplyAPY = parseFloat(usdcPool.supplyIncentiveApyInfo?.apy || '0');
      const borrowAPY = parseFloat(usdcPool.borrowIncentiveApyInfo?.apy || '0');
      
      // Calculate utilization rate
      const totalSupply = parseFloat(usdcPool.totalSupply || '0');
      const totalBorrow = parseFloat(usdcPool.totalBorrow || '0');
      const utilizationRate = totalSupply > 0 ? totalBorrow / totalSupply : 0;

      return {
        supplyAPY,
        borrowAPY,
        utilizationRate,
        totalSupply: usdcPool.totalSupply || '0',
        totalBorrow: usdcPool.totalBorrow || '0',
        availableLiquidity: usdcPool.availableBorrow || '0'
      };
    } catch (error) {
      console.error('‚ùå Error fetching pool stats:', error);
      return {
        supplyAPY: 0,
        borrowAPY: 0,
        utilizationRate: 0,
        totalSupply: '0',
        totalBorrow: '0',
        availableLiquidity: '0'
      };
    }
  }

  /**
   * Initialize service and log current APY
   */
  async initialize(): Promise<void> {
    console.log('‚úÖ NAVI service initializing...');
    
    try {
      const apy = await this.getUSDCSupplyAPY();
      console.log(`   ‚úÖ Live USDC Supply APY: ${apy.toFixed(2)}%`);
      
      const stats = await this.getUSDCPoolStats();
      console.log(`   üìä Borrow APY: ${stats.borrowAPY.toFixed(2)}%`);
      console.log(`   üìä Utilization: ${(stats.utilizationRate * 100).toFixed(2)}%`);
    } catch (error) {
      console.error('‚ùå FAILED TO GET LIVE APY:', error);
    }
  }

  /**
   * Format USDC amount
   */
  formatUSDC(amount: string | bigint): string {
    const value = Number(amount) / 1_000_000;
    return value.toFixed(2);
  }

  /**
   * Calculate daily earnings
   */
  calculateDailyEarnings(balance: bigint, apy: number): bigint {
    const dailyRate = apy / 365 / 100;
    const earnings = Number(balance) * dailyRate;
    return BigInt(Math.floor(earnings));
  }

  /**
   * Calculate monthly earnings
   */
  calculateMonthlyEarnings(balance: bigint, apy: number): bigint {
    const monthlyRate = apy / 12 / 100;
    const earnings = Number(balance) * monthlyRate;
    return BigInt(Math.floor(earnings));
  }
}

// Export singleton
export const naviService = new NaviService();
